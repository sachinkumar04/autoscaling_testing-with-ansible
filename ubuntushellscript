#!/bin/bash

# Update the package repository
sudo apt update -y

# Install necessary utilities
sudo apt install -y software-properties-common

# Add the Ansible PPA repository
sudo apt-add-repository --yes --update ppa:ansible/ansible

# Install Ansible and other required packages
sudo apt install -y ansible nginx python3-apt git stress

# Fix broken dependencies if there are any
sudo apt --fix-broken install -y

# Check if /myrepo exists, and remove it if so
if [ -d "/myrepo" ]; then
  echo "/myrepo already exists. Removing it..."
  sudo rm -rf /myrepo
fi

# Clone the repository
sudo git clone https://github.com/sachinkumar04/autoscaling_testing-with-ansible.git /myrepo

# Wait for a moment to ensure everything is in place
sleep 10

# Run the Ansible playbook (ensure it runs on localhost to avoid 'empty hosts list' warning)
sudo ansible-playbook -i localhost, /myrepo/playbook.yaml

# Final cleanup
sudo apt autoremove -y
sudo apt clean

echo "Setup completed successfully!"


######GIVE ONLY ABOVE IN THE USER DATA FOR AMI IMAGE FOR AWS AUTOSCALING##########
#
#####GIVE BELOW IN THE LAUNCH CONFIG USERDATA#####################################
ansible-playbook /myrepo/playbook.yaml

######GIVE BELOW IN THE CUSTOM DATA OF AZURE VMSSS################################
#cloud-config
package_upgrade: true
packages:
  - jq

runcmd:
  - ansible-playbook /myrepo/playbook.yaml
